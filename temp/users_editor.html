<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Редактор сайта - user.html</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    body { overflow: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .editor-preview { transform: scale(0.9); transform-origin: top center; transition: all 0.3s ease; height: 100%; overflow: hidden; position: relative; }
    .main-container { height: 100vh; overflow: hidden; display: flex; }
    .preview-container { height: calc(100vh - 4rem); overflow: hidden; position: relative; }
    .preview-content { height: 100%; overflow-y: auto; padding: 2rem; }
    .editor-panel { height: calc(100vh - 4rem); overflow-y: auto; }
    .sidebar { height: calc(100vh - 4rem); overflow-y: auto; }
  </style>
</head>
<body class="h-screen bg-gray-50 flex" style="font-family: system-ui, -apple-system, sans-serif;">
<div x-data="userPageEditor()" class="main-container">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between fixed top-0 left-0 right-0 z-40 shadow-sm">
    <div class="flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-sm">R</span>
        </div>
        <span class="font-semibold text-gray-900">Редактор user.html</span>
      </div>
    </div>
    <div class="flex items-center space-x-4">
      <button @click="save" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
        <i data-lucide="save" class="w-4 h-4"></i>
        <span>Сохранить</span>
      </button>
      <button @click="reset" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center space-x-2">
        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
        <span>Сбросить</span>
      </button>
    </div>
  </header>
  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r border-gray-200 p-4 space-y-6 fixed left-0 top-16 bottom-0 overflow-y-auto no-scrollbar z-40 sidebar">
    <div class="pt-2">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-medium text-gray-900">Навигация</h3>
      </div>
      <div class="space-y-1.5">
        <button @click="selectedSection = 'main'" :class="selectedSection === 'main' ? 'bg-blue-50' : ''" class="w-full flex items-center space-x-2 px-3 py-2.5 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
          <i data-lucide="home" class="w-4 h-4 flex-shrink-0"></i>
          <span>Основное</span>
        </button>
        <button @click="selectedSection = 'services'" :class="selectedSection === 'services' ? 'bg-blue-50' : ''" class="w-full flex items-center space-x-2 px-3 py-2.5 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
          <i data-lucide="scissors" class="w-4 h-4 flex-shrink-0"></i>
          <span>Услуги</span>
        </button>
        <button @click="selectedSection = 'specialists'" :class="selectedSection === 'specialists' ? 'bg-blue-50' : ''" class="w-full flex items-center space-x-2 px-3 py-2.5 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
          <i data-lucide="users" class="w-4 h-4 flex-shrink-0"></i>
          <span>Специалисты</span>
        </button>
        <button @click="selectedSection = 'theme'" :class="selectedSection === 'theme' ? 'bg-blue-50' : ''" class="w-full flex items-center space-x-2 px-3 py-2.5 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
          <i data-lucide="palette" class="w-4 h-4 flex-shrink-0"></i>
          <span>Тема</span>
        </button>
        <button @click="selectedSection = 'preview'" :class="selectedSection === 'preview' ? 'bg-blue-50' : ''" class="w-full flex items-center space-x-2 px-3 py-2.5 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
          <i data-lucide="eye" class="w-4 h-4 flex-shrink-0"></i>
          <span>Превью</span>
        </button>
      </div>
    </div>
  </aside>
  <!-- Main Content -->
  <div class="flex-1 ml-64 pt-16">
    <div class="flex">
      <!-- Editor Panel -->
      <div class="w-96 bg-white border-r border-gray-200 p-6 overflow-y-auto editor-panel">
        <div x-show="selectedSection === 'main'">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Основная информация</h2>
            <p class="text-sm text-gray-500">Редактируйте главные данные для user.html</p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Название салона</label>
            <input type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                   x-model="main.title" 
                   @input.debounce.300ms="updatePreview()">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Адрес</label>
            <input type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                   x-model="main.address" 
                   @input.debounce.300ms="updatePreview()">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
            <input type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                   x-model="main.phone" 
                   @input.debounce.300ms="updatePreview()">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
            <input type="email" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                   x-model="main.email" 
                   @input.debounce.300ms="updatePreview()">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
            <textarea class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                      rows="3" 
                      x-model="main.description" 
                      @input.debounce.300ms="updatePreview()"></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Социальные сети</label>
            <template x-for="(social, idx) in main.socials" :key="idx">
              <div class="flex items-center gap-2 mb-2">
                <input x-model="main.socials[idx]" 
                       class="flex-1 border border-gray-200 rounded-lg p-2" 
                       placeholder="Ссылка на соцсеть" 
                       @input.debounce.300ms="updatePreview()" />
                <button @click="removeSocial(idx)" class="p-1 text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
            </template>
            <button @click="addSocial" class="mt-2 px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> Добавить соцсеть
            </button>
          </div>
        </div>
        <!-- Остальные секции будут добавлены далее -->
      </div>
      <!-- Preview Panel -->
      <div class="flex-1 p-8 overflow-y-auto preview-container">
        <div class="max-w-4xl mx-auto editor-preview">
          <div class="preview-content">
            <iframe src="user.html" class="w-full h-full rounded-xl border shadow-lg bg-white" title="Предпросмотр user.html" 
                    @load="updatePreview()"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
function userPageEditor() {
  return {
    selectedSection: 'main',
    main: JSON.parse(localStorage.getItem('ue_main')) || {
      title: 'Салон красоты "Элегант"',
      address: 'г. Бишкек, ул. Исанова, 42',
      phone: '+996 700 123 456',
      email: 'info@archa-beauty.kg',
      description: 'Лучший салон красоты в Бишкеке!',
      socials: ['https://t.me/yourtg','https://instagram.com/yourinsta']
    },
    addSocial() { 
      this.main.socials.push(''); 
      this.updatePreview();
    },
    removeSocial(idx) { 
      this.main.socials.splice(idx, 1); 
      this.updatePreview();
    },
    updatePreview() {
      // Создаем динамическое содержимое для превью
      const iframe = document.querySelector('iframe');
      if (iframe) {
        // Получаем базовое содержимое user.html
        fetch('user.html')
          .then(response => response.text())
          .then(html => {
            // Заменяем данные в HTML
            let modifiedHtml = html;
            
            // Заменяем заголовок
            modifiedHtml = modifiedHtml.replace(
              /Салон красоты "Элегант"/g, 
              this.main.title
            );
            
            // Заменяем в title теге
            modifiedHtml = modifiedHtml.replace(
              /<title>.*?<\/title>/,
              '<title>' + this.main.title + ' - Booking</title>'
            );
            
            // Добавляем простой скрипт для обновления данных
            const scriptContent = 'window.userData=' + JSON.stringify(this.main) + ';';
            const scriptTag = '<script>' + scriptContent + '</script>';
            
            // Вставляем скрипт перед закрывающим тегом head
            modifiedHtml = modifiedHtml.replace('</head>', scriptTag + '</head>');
            
            // Создаем blob URL для iframe
            const blob = new Blob([modifiedHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            iframe.src = url;
          })
          .catch(error => {
            console.error('Ошибка загрузки user.html:', error);
          });
      }
    },
    save() {
      localStorage.setItem('ue_main', JSON.stringify(this.main));
      alert('Сохранено!');
    },
    reset() {
      if(confirm('Сбросить все изменения?')) {
        localStorage.removeItem('ue_main');
        location.reload();
      }
    },
    init() {
      // Инициализация при загрузке
      this.$nextTick(() => {
        this.updatePreview();
        this.injectPreviewScript();
      });
    },
    injectPreviewScript() {
      const iframe = document.querySelector('iframe');
      if (iframe) {
        iframe.addEventListener('load', () => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const script = iframeDoc.createElement('script');
            script.textContent = `
              window.addEventListener('message', function(event) {
                if (event.data.type === 'UPDATE_USER_DATA') {
                  const data = event.data.data;
                  
                  // Обновляем заголовок
                  const titleElement = document.querySelector('h1, .title, #title');
                  if (titleElement) titleElement.textContent = data.title;
                  
                  // Обновляем адрес
                  const addressElements = document.querySelectorAll('.address, [data-address]');
                  addressElements.forEach(el => el.textContent = data.address);
                  
                  // Обновляем телефон
                  const phoneElements = document.querySelectorAll('.phone, [data-phone], a[href^="tel:"]');
                  phoneElements.forEach(el => {
                    if (el.tagName === 'A') {
                      el.href = 'tel:' + data.phone;
                      el.textContent = data.phone;
                    } else {
                      el.textContent = data.phone;
                    }
                  });
                  
                  // Обновляем email
                  const emailElements = document.querySelectorAll('.email, [data-email], a[href^="mailto:"]');
                  emailElements.forEach(el => {
                    if (el.tagName === 'A') {
                      el.href = 'mailto:' + data.email;
                      el.textContent = data.email;
                    } else {
                      el.textContent = data.email;
                    }
                  });
                  
                  // Обновляем описание
                  const descElements = document.querySelectorAll('.description, .desc, [data-description]');
                  descElements.forEach(el => el.textContent = data.description);
                  
                  // Обновляем социальные сети
                  const socialElements = document.querySelectorAll('.socials a, [data-social]');
                  data.socials.forEach((social, index) => {
                    if (socialElements[index]) {
                      socialElements[index].href = social;
                    }
                  });
                }
              });
            `;
            iframeDoc.head.appendChild(script);
          } catch (e) {
            console.log('Не удалось внедрить скрипт в iframe:', e);
          }
        });
      }
    }
  }
}
</script>
</body>
</html>