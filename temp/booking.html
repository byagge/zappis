<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resso Booking Admin</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="h-screen bg-gray-50 flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <div x-data="ressoBooking()">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between fixed top-0 left-0 right-0 z-30">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">R</span>
                    </div>
                    <span class="font-semibold text-gray-900">Resso</span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-600">Салон красоты "Элегант"</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button @click="showBookingModal = true; selectedBooking = null; setBookingForm()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Добавить запись</span>
                </button>
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button @click="view = 'day'"
                            :class="{'bg-white shadow-sm text-blue-600': view === 'day', 'text-gray-600 hover:text-gray-900': view !== 'day'}"
                            class="px-3 py-1 rounded-md text-sm transition-colors">
                        День
                    </button>
                    <button @click="view = 'week'"
                            :class="{'bg-white shadow-sm text-blue-600': view === 'week', 'text-gray-600 hover:text-gray-900': view !== 'week'}"
                            class="px-3 py-1 rounded-md text-sm transition-colors">
                        Неделя
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <button @click="changeDate(-1)" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <span class="text-lg font-semibold text-gray-900 min-w-[200px] text-center" x-text="formatDate(currentDate)"></span>
                    <button @click="changeDate(1)" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-4 h-4 text-white"></i>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden pt-16">
            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r border-gray-200 p-4 space-y-6 fixed left-0 top-16 bottom-0 overflow-y-auto no-scrollbar">
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-medium text-gray-900" x-text="formatMonthYear(currentDate)"></h3>
                        <div class="flex space-x-2">
                            <button @click="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <button @click="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-xs">
                        <template x-for="day in ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс']" :key="day">
                            <div class="text-center text-gray-500 py-1" x-text="day"></div>
                        </template>
                        <template x-for="day in getDaysInMonth(currentDate)" :key="day">
                            <button @click="setDate(day)"
                                    :class="{'bg-blue-600 text-white': day === currentDate.getDate() && isSameMonth(currentDate), 'text-gray-700 hover:text-blue-600': day !== currentDate.getDate() || !isSameMonth(currentDate)}"
                                    class="text-center py-1 rounded hover:bg-blue-50 transition-colors">
                                <span x-text="day"></span>
                            </button>
                        </template>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Мастера</h3>
                    <select x-model="selectedMaster"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <template x-for="master in masters" :key="master.id">
                            <option :value="master.id" x-text="master.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Поиск клиента</h3>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input type="text" 
                               placeholder="Поиск по имени или телефону..."
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               x-model="searchQuery"
                               @input="searchClients">
                    </div>
                    <!-- Search Results -->
                    <div class="mt-2 max-h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-sm">
                        <template x-for="result in searchResults" :key="result.id">
                            <div class="p-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                 @click="selectClient(result)">
                                <div class="font-medium text-sm" x-text="result.clientName"></div>
                                <div class="text-xs text-gray-500" x-text="result.phone"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </aside>

            <!-- Main Calendar -->
            <main class="flex-1 overflow-auto ml-64 no-scrollbar" style="scroll-behavior: smooth;">
                <div class="min-w-[800px]">
                    <div class="bg-white border-b border-gray-200 sticky top-0 z-20">
                        <div class="flex">
                            <div class="w-16 border-r border-gray-200"></div>
                            <template x-if="view === 'week'">
                                <template x-for="date in getWeekDays()" :key="date.toISOString()">
                                    <div class="flex-1 p-4 text-center border-r border-gray-200 last:border-r-0">
                                        <div class="text-sm text-gray-500" x-text="getDayName(date)"></div>
                                        <div :class="{'text-blue-600': isToday(date), 'text-gray-900': !isToday(date)}"
                                             class="text-xl font-semibold" x-text="date.getDate()"></div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="view === 'day'">
                                <div class="flex-1 p-4 text-center">
                                    <div class="text-sm text-gray-500" x-text="getDayName(currentDate)"></div>
                                    <div :class="{'text-blue-600': isToday(currentDate), 'text-gray-900': !isToday(currentDate)}"
                                         class="text-xl font-semibold" x-text="currentDate.getDate()"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="flex">
                        <div class="w-16 border-r border-gray-200">
                            <div class="h-10"></div>
                            <template x-for="(time, index) in timeSlots" :key="time">
                                <div class="h-10 border-b border-gray-100 flex items-center justify-center text-xs text-gray-500"
                                     x-text="index % 2 === 0 ? time : ''"></div>
                            </template>
                        </div>
                        <template x-if="view === 'week'">
                            <template x-for="date in getWeekDays()" :key="date.toISOString()">
                                <div class="flex-1 border-r border-gray-200 last:border-r-0 relative">
                                    <div class="h-10 bg-gray-50"></div>
                                    <template x-for="slot in timeSlots" :key="slot">
                                        <div class="h-10 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors relative"
                                             @click="showBookingModal = true; selectedBooking = null; setBookingForm(slot, date)"></div>
                                    </template>
                                    <template x-for="booking in getBookingsForDate(date)" :key="booking.id">
                                        <div class="absolute left-1 right-1 rounded-lg p-2 text-white text-xs cursor-pointer shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-[1.02] z-10"
                                             :style="getBookingStyle(booking)"
                                             @click="selectedBooking = booking; showBookingModal = true; setBookingForm()">
                                            <div class="font-medium truncate" x-text="booking.clientName"></div>
                                            <div class="text-white/80 truncate" x-text="booking.service"></div>
                                            <div class="text-white/70 text-xs" x-text="booking.startTime + '-' + booking.endTime"></div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </template>
                        <template x-if="view === 'day'">
                            <div class="flex-1 relative">
                                <div class="h-10 bg-gray-50"></div>
                                <template x-for="slot in timeSlots" :key="slot">
                                    <div class="h-10 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors relative"
                                         @click="showBookingModal = true; selectedBooking = null; setBookingForm(slot, currentDate)"></div>
                                </template>
                                <template x-for="booking in getBookingsForDate(currentDate)" :key="booking.id">
                                    <div class="absolute left-1 right-1 rounded-lg p-2 text-white text-xs cursor-pointer shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-[1.02] z-10"
                                         :style="getBookingStyle(booking)"
                                         @click="selectedBooking = booking; showBookingModal = true; setBookingForm()">
                                        <div class="font-medium truncate" x-text="booking.clientName"></div>
                                        <div class="text-white/80 truncate" x-text="booking.service"></div>
                                        <div class="text-white/70 text-xs" x-text="booking.startTime + '-' + booking.endTime"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>

        <!-- Booking Form -->
        <div x-show="showBookingModal" 
             class="fixed inset-0 z-50"
             :class="{'lg:flex lg:items-center lg:justify-center': true}">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black bg-opacity-50 lg:bg-opacity-0"></div>
            
            <!-- Form Container -->
            <div class="fixed inset-0 lg:relative lg:inset-auto lg:max-w-6xl lg:w-full lg:mx-4 lg:my-8 bg-white lg:rounded-xl lg:shadow-2xl overflow-hidden flex flex-col lg:flex-row">
                <!-- Left Side - Form -->
                <div class="flex-1 p-4 sm:p-6 overflow-y-auto">
                    <!-- Mobile Header -->
                    <div class="flex justify-between items-center mb-4 sm:mb-6 sticky top-0 bg-white pb-4 border-b border-gray-200 lg:border-none lg:pb-0 lg:static">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-900" x-text="selectedBooking ? 'Редактировать запись' : 'Новая запись'"></h3>
                        <button @click="showBookingModal = false; selectedBooking = null" 
                                class="text-gray-400 hover:text-gray-600 lg:hidden">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        <!-- Date and Time Section -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Дата</label>
                                <input type="date" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                       :class="{'border-red-500': errors.date}"
                                       x-model="bookingForm.date">
                                <div x-show="errors.date" class="mt-1 text-sm text-red-600" x-text="errors.date"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Время начала</label>
                                    <input type="time" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                           :class="{'border-red-500': errors.startTime}"
                                           x-model="bookingForm.startTime">
                                    <div x-show="errors.startTime" class="mt-1 text-sm text-red-600" x-text="errors.startTime"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Время окончания
                                        <!-- <span class="text-red-500">*</span> -->
                                    </label>
                                    <input type="time" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                           :class="{'border-red-500': errors.endTime}"
                                           x-model="bookingForm.endTime" required>
                                    <div x-show="errors.endTime" class="mt-1 text-sm text-red-600" x-text="errors.endTime"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Info Section -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Клиент</label>
                                <input type="text" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                       :class="{'border-red-500': errors.clientName}"
                                       x-model="bookingForm.clientName" 
                                       placeholder="Имя клиента">
                                <div x-show="errors.clientName" class="mt-1 text-sm text-red-600" x-text="errors.clientName"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
                                <input type="tel" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                       :class="{'border-red-500': errors.phone}"
                                       x-model="bookingForm.phone" 
                                       @input="formatPhoneNumber"
                                       placeholder="+996 500 123 456">
                                <div x-show="errors.phone" class="mt-1 text-sm text-red-600" x-text="errors.phone"></div>
                            </div>
                        </div>

                        <!-- Service Section -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Услуга</label>
                                <select class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base appearance-none bg-white"
                                        :class="{'border-red-500': errors.service}"
                                        x-model="bookingForm.service">
                                    <option value="">Выберите услугу</option>
                                    <option>Стрижка + Укладка</option>
                                    <option>Маникюр</option>
                                    <option>Педикюр</option>
                                    <option>Массаж лица</option>
                                    <option>Окрашивание</option>
                                </select>
                                <div x-show="errors.service" class="mt-1 text-sm text-red-600" x-text="errors.service"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Мастер</label>
                                <select class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base appearance-none bg-white"
                                        :class="{'border-red-500': errors.masterId}"
                                        x-model="bookingForm.masterId">
                                    <option value="">Выберите мастера</option>
                                    <template x-for="master in masters.filter(m => m.id !== 'all')" :key="master.id">
                                        <option :value="master.id" x-text="master.name"></option>
                                    </template>
                                </select>
                                <div x-show="errors.masterId" class="mt-1 text-sm text-red-600" x-text="errors.masterId"></div>
                            </div>
                        </div>

                        <!-- Price Section -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Стоимость</label>
                                <div class="relative">
                                    <input type="number" 
                                           class="w-full border border-gray-300 rounded-lg pl-8 pr-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                           :class="{'border-red-500': errors.price}"
                                           x-model="bookingForm.price" 
                                           placeholder="Введите стоимость"
                                           min="0"
                                           @input="formatPrice">
                                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">⃀</div>
                                </div>
                                <div x-show="errors.price" class="mt-1 text-sm text-red-600" x-text="errors.price"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200 sticky bottom-0 bg-white lg:static">
                        <template x-if="selectedBooking">
                            <button @click="deleteBooking(selectedBooking.id)"
                                    class="px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </template>
                        <button @click="showBookingModal = false; selectedBooking = null"
                                class="px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                            Отмена
                        </button>
                        <button @click="saveBooking"
                                class="px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <span x-text="selectedBooking ? 'Сохранить' : 'Создать'"></span>
                        </button>
                    </div>
                </div>

                <!-- Right Side - Preview -->
                <div class="hidden lg:block w-80 bg-gray-50 p-6 border-l border-gray-200">
                    <h4 class="text-sm font-medium text-gray-900 mb-4">Предпросмотр записи</h4>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Дата и время</div>
                                <div class="text-sm font-medium text-gray-900" x-text="formatDate(new Date(bookingForm.date)) + ' ' + bookingForm.startTime + ' - ' + bookingForm.endTime"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Клиент</div>
                                <div class="text-sm font-medium text-gray-900" x-text="bookingForm.clientName || 'Не указано'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <i data-lucide="scissors" class="w-5 h-5 text-purple-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Услуга</div>
                                <div class="text-sm font-medium text-gray-900" x-text="bookingForm.service || 'Не выбрано'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user-check" class="w-5 h-5 text-orange-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Мастер</div>
                                <div class="text-sm font-medium text-gray-900" x-text="masters.find(m => m.id === bookingForm.masterId)?.name || 'Не выбран'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                <i data-lucide="credit-card" class="w-5 h-5 text-red-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Стоимость</div>
                                <div class="text-sm font-medium text-gray-900" x-text="bookingForm.price ? bookingForm.price + ' ⃀' : 'Не указано'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SMS Notification Modal -->
        <div x-show="showSmsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Уведомить клиента?</h3>
                    <button @click="showSmsModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <p class="text-gray-600">Отправить клиенту SMS с информацией о записи?</p>
                    <div class="flex justify-end space-x-3">
                        <button @click="showSmsModal = false"
                                class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                            Пропустить
                        </button>
                        <button @click="sendSms(); showSmsModal = false"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Отправить SMS
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div x-show="toast" class="fixed top-4 right-4 z-50">
            <div :class="{'bg-green-500': toast.type === 'success', 'bg-red-500': toast.type === 'error'}"
                 class="px-4 py-3 rounded-lg shadow-lg text-white">
                <span x-text="toast.message"></span>
            </div>
        </div>
    </div>

    <!-- Alpine.js Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('ressoBooking', () => ({
                currentDate: new Date(2025, 5, 15),
                view: 'week',
                selectedMaster: 'all',
                showBookingModal: false,
                showSmsModal: false,
                selectedBooking: null,
                bookingForm: {
                    clientName: '',
                    service: '',
                    masterId: '',
                    startTime: '09:00',
                    endTime: '10:00',
                    phone: '',
                    price: 0,
                    date: '2025-06-15'
                },
                errors: {},
                toast: null,
                searchQuery: '',
                searchResults: [],
                masters: [
                    { id: 'all', name: 'Все мастера', color: '#6366F1' },
                    { id: '1', name: 'Анна Петрова', color: '#3D5AFE' },
                    { id: '2', name: 'Мария Иванова', color: '#10B981' },
                    { id: '3', name: 'Елена Сидорова', color: '#F59E0B' }
                ],
                bookings: [
                    {
                        id: 1,
                        clientName: 'Ольга Козлова',
                        service: 'Стрижка + Укладка',
                        masterId: '1',
                        date: '2025-06-15',
                        startTime: '09:00',
                        endTime: '10:30',
                        phone: '+7 (999) 123-45-67',
                        price: 3500
                    },
                    {
                        id: 2,
                        clientName: 'Мария Петрова',
                        service: 'Маникюр',
                        masterId: '2',
                        date: '2025-06-15',
                        startTime: '11:00',
                        endTime: '12:30',
                        phone: '+7 (999) 234-56-78',
                        price: 2000
                    },
                    {
                        id: 3,
                        clientName: 'Екатерина Смирнова',
                        service: 'Массаж лица',
                        masterId: '3',
                        date: '2025-06-16',
                        startTime: '14:00',
                        endTime: '15:00',
                        phone: '+7 (999) 345-67-89',
                        price: 4000
                    }
                ],
                timeSlots: Array.from({ length: 26 }, (_, i) => {
                    const hour = Math.floor(i / 2) + 7;
                    const minute = i % 2 === 0 ? '00' : '30';
                    return `${hour.toString().padStart(2, '0')}:${minute}`;
                }),

                formatDate(date) {
                    return new Intl.DateTimeFormat('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' }).format(date);
                },
                formatMonthYear(date) {
                    return new Intl.DateTimeFormat('ru-RU', { month: 'long', year: 'numeric' }).format(date);
                },
                getDaysInMonth(date) {
                    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                },
                isSameMonth(date) {
                    const today = new Date();
                    return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
                },
                getWeekDays() {
                    const startOfWeek = new Date(this.currentDate);
                    const day = startOfWeek.getDay();
                    const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                    startOfWeek.setDate(diff);
                    const days = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + i);
                        days.push(date);
                    }
                    return days;
                },
                getDayName(date) {
                    return ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][date.getDay()];
                },
                isToday(date) {
                    const today = new Date(2025, 5, 15);
                    return date.toDateString() === today.toDateString();
                },
                getBookingsForDate(date) {
                    const dateStr = date.toISOString().split('T')[0];
                    return this.bookings.filter(booking => {
                        const matchesDate = booking.date === dateStr;
                        const matchesMaster = this.selectedMaster === 'all' || booking.masterId === this.selectedMaster;
                        return matchesDate && matchesMaster;
                    });
                },
                getBookingStyle(booking) {
                    const start = booking.startTime.split(':').map(Number);
                    const end = booking.endTime.split(':').map(Number);
                    const startMinutes = (start[0] - 7) * 60 + start[1];
                    const endMinutes = (end[0] - 7) * 60 + end[1];
                    const top = `${(startMinutes / 30) * 2.5}rem`;
                    const height = `${((endMinutes - startMinutes) / 30) * 2.5}rem`;
                    const master = this.masters.find(m => m.id === booking.masterId);
                    const color = master ? master.color : '#6366F1';
                    
                    // Calculate position for overlapping bookings
                    const overlappingBookings = this.getOverlappingBookings(booking);
                    const index = overlappingBookings.findIndex(b => b.id === booking.id);
                    const totalOverlapping = overlappingBookings.length;
                    const width = `${100 / totalOverlapping}%`;
                    const left = `${(index * 100) / totalOverlapping}%`;
                    
                    return `top: ${top}; height: ${height}; background-color: ${color}; border: 2px solid ${color}; width: ${width}; left: ${left};`;
                },
                getOverlappingBookings(booking) {
                    return this.bookings.filter(b => {
                        if (b.id === booking.id) return true;
                        if (b.date !== booking.date) return false;
                        
                        const bStart = this.timeToMinutes(b.startTime);
                        const bEnd = this.timeToMinutes(b.endTime);
                        const bookingStart = this.timeToMinutes(booking.startTime);
                        const bookingEnd = this.timeToMinutes(booking.endTime);
                        
                        return (bStart < bookingEnd && bEnd > bookingStart);
                    });
                },
                timeToMinutes(time) {
                    const [hours, minutes] = time.split(':').map(Number);
                    return hours * 60 + minutes;
                },
                isTimeSlotAvailable(startTime, endTime, masterId, excludeBookingId = null) {
                    const start = this.timeToMinutes(startTime);
                    const end = this.timeToMinutes(endTime);
                    
                    return !this.bookings.some(booking => {
                        if (booking.id === excludeBookingId) return false;
                        if (booking.masterId !== masterId) return false;
                        
                        const bookingStart = this.timeToMinutes(booking.startTime);
                        const bookingEnd = this.timeToMinutes(booking.endTime);
                        
                        return (start < bookingEnd && end > bookingStart);
                    });
                },
                changeDate(delta) {
                    const newDate = new Date(this.currentDate);
                    const increment = this.view === 'week' ? 7 : 1;
                    newDate.setDate(newDate.getDate() + delta * increment);
                    this.currentDate = newDate;
                },
                setDate(day) {
                    this.currentDate = new Date(2025, 5, day);
                },
                setBookingForm(clickedTime = null, clickedDate = null) {
                    if (this.selectedBooking) {
                        this.bookingForm = { ...this.selectedBooking };
                        // Если время окончания не установлено, устанавливаем его автоматически
                        if (!this.bookingForm.endTime && this.bookingForm.startTime) {
                            const [hours, minutes] = this.bookingForm.startTime.split(':').map(Number);
                            const endHours = (hours + 1) % 24;
                            this.bookingForm.endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                        }
                    } else {
                        const startTime = clickedTime || '09:00';
                        const [hours, minutes] = startTime.split(':').map(Number);
                        const endTime = `${hours + 1}:${minutes.toString().padStart(2, '0')}`;
                        
                        // Create a new date object from the clicked date
                        let dateToUse;
                        if (clickedDate) {
                            dateToUse = new Date(clickedDate);
                        } else {
                            dateToUse = new Date(this.currentDate);
                        }
                        
                        // Ensure we're using the correct date
                        const year = dateToUse.getFullYear();
                        const month = dateToUse.getMonth();
                        const day = dateToUse.getDate();
                        const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        
                        this.bookingForm = {
                            clientName: '',
                            service: '',
                            masterId: '',
                            startTime: startTime,
                            endTime: endTime,
                            phone: '',
                            price: 0,
                            date: formattedDate
                        };
                    }
                },
                validateForm() {
                    this.errors = {};
                    let isValid = true;

                    if (!this.bookingForm.date) {
                        this.errors.date = 'Выберите дату';
                        isValid = false;
                    }

                    if (!this.bookingForm.startTime) {
                        this.errors.startTime = 'Выберите время начала';
                        isValid = false;
                    }

                    // Автоматически устанавливаем время окончания, если оно не указано
                    if (!this.bookingForm.endTime && this.bookingForm.startTime) {
                        const [hours, minutes] = this.bookingForm.startTime.split(':').map(Number);
                        const endHours = (hours + 1) % 24;
                        this.bookingForm.endTime = `${String(endHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    }

                    if (this.bookingForm.endTime) {
                        const start = this.timeToMinutes(this.bookingForm.startTime);
                        const end = this.timeToMinutes(this.bookingForm.endTime);
                        if (end <= start) {
                            this.errors.endTime = 'Время окончания должно быть позже времени начала';
                            isValid = false;
                        }
                    }

                    if (!this.bookingForm.clientName) {
                        this.errors.clientName = 'Введите имя клиента';
                        isValid = false;
                    }

                    if (!this.bookingForm.service) {
                        this.errors.service = 'Выберите услугу';
                        isValid = false;
                    }

                    if (!this.bookingForm.masterId) {
                        this.errors.masterId = 'Выберите мастера';
                        isValid = false;
                    }

                    if (!this.bookingForm.phone) {
                        this.errors.phone = 'Введите номер телефона';
                        isValid = false;
                    } else {
                        // Валидация кыргызского номера
                        const phoneRegex = /^\+996\s(500|501|502|505|550|551|552|553|554|555|556|557|558|559|700|701|702|703|704|705|706|707|708|709|770|771|772|773|774|775|776|777|778|779|990)\s\d{3}\s\d{3}$/;
                        if (!phoneRegex.test(this.bookingForm.phone)) {
                            this.errors.phone = 'Введите корректный номер телефона';
                            isValid = false;
                        }
                    }

                    if (!this.bookingForm.price) {
                        this.errors.price = 'Введите стоимость';
                        isValid = false;
                    } else if (this.bookingForm.price <= 0) {
                        this.errors.price = 'Стоимость должна быть больше 0';
                        isValid = false;
                    }

                    return isValid;
                },
                saveBooking() {
                    if (!this.validateForm()) {
                        return;
                    }

                    if (!this.isTimeSlotAvailable(
                        this.bookingForm.startTime,
                        this.bookingForm.endTime,
                        this.bookingForm.masterId,
                        this.selectedBooking?.id
                    )) {
                        this.showToast('Выбранное время уже занято для этого мастера', 'error');
                        return;
                    }

                    if (this.selectedBooking) {
                        const index = this.bookings.findIndex(b => b.id === this.selectedBooking.id);
                        this.bookings[index] = { ...this.bookingForm, id: this.selectedBooking.id };
                        this.showToast('Запись обновлена', 'success');
                    } else {
                        const newBooking = { ...this.bookingForm, id: Date.now() };
                        this.bookings.push(newBooking);
                        this.showToast('Запись создана', 'success');
                    }
                    this.showBookingModal = false;
                    this.selectedBooking = null;
                    this.errors = {};
                    
                    // Show SMS notification modal
                    this.showSmsModal = true;
                },
                deleteBooking(id) {
                    this.bookings = this.bookings.filter(b => b.id !== id);
                    this.showBookingModal = false;
                    this.selectedBooking = null;
                    this.showToast('Запись удалена', 'success');
                },
                showToast(message, type) {
                    this.toast = { message, type };
                    setTimeout(() => this.toast = null, 3000);
                },
                changeMonth(delta) {
                    const newDate = new Date(this.currentDate);
                    newDate.setMonth(newDate.getMonth() + delta);
                    this.currentDate = newDate;
                },
                getSmsContent() {
                    const date = new Date(this.bookingForm.date);
                    const formattedDate = new Intl.DateTimeFormat('ru-RU', {
                        day: 'numeric',
                        month: 'long',
                        weekday: 'long'
                    }).format(date);
                    
                    const master = this.masters.find(m => m.id === this.bookingForm.masterId);
                    const masterName = master ? master.name : '';

                    return `Здравствуйте, ${this.bookingForm.clientName}!\n\n` +
                           `Напоминаем о записи в салон красоты "Элегант":\n` +
                           `📅 ${formattedDate}\n` +
                           `⏰ ${this.bookingForm.startTime} - ${this.bookingForm.endTime}\n` +
                           `💇‍♀️ ${this.bookingForm.service}\n` +
                           `👩‍💼 Мастер: ${masterName}\n\n` +
                           `Стоимость: ${this.bookingForm.price} ₽\n\n` +
                           `Будем рады видеть вас!`;
                },
                sendSms() {
                    // Here would be the actual SMS sending logic
                    this.showToast('SMS отправлено клиенту', 'success');
                },
                formatPhoneNumber(event) {
                    let value = event.target.value.replace(/\D/g, '');
                    
                    // Если номер начинается не с 996, добавляем код страны
                    if (!value.startsWith('996')) {
                        value = '996' + value;
                    }
                    
                    // Ограничиваем длину номера
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    
                    // Форматируем номер
                    let formattedNumber = '+';
                    if (value.length > 0) {
                        formattedNumber += value.slice(0, 3);
                        if (value.length > 3) {
                            formattedNumber += ' ' + value.slice(3, 6);
                            if (value.length > 6) {
                                formattedNumber += ' ' + value.slice(6, 9);
                                if (value.length > 9) {
                                    formattedNumber += ' ' + value.slice(9, 12);
                                }
                            }
                        }
                    }
                    
                    this.bookingForm.phone = formattedNumber;
                },
                formatPrice(event) {
                    // Удаляем все нецифровые символы
                    let value = event.target.value.replace(/\D/g, '');
                    
                    // Если значение пустое, устанавливаем null
                    if (value === '') {
                        this.bookingForm.price = null;
                        return;
                    }
                    
                    // Преобразуем в число
                    let numValue = parseInt(value);
                    
                    // Устанавливаем значение
                    this.bookingForm.price = numValue;
                },
                init() {
                    // Инициализация списка клиентов при загрузке
                    this.searchResults = this.bookings;
                },
                searchClients() {
                    const query = this.searchQuery.toLowerCase().trim();
                    if (!query) {
                        this.searchResults = this.bookings;
                        return;
                    }

                    this.searchResults = this.bookings.filter(booking => {
                        const nameMatch = booking.clientName.toLowerCase().includes(query);
                        const phoneMatch = booking.phone.toLowerCase().includes(query);
                        return nameMatch || phoneMatch;
                    });
                },
                selectClient(client) {
                    this.bookingForm.clientName = client.clientName;
                    this.bookingForm.phone = client.phone;
                    this.searchQuery = '';
                    this.searchResults = [];
                }
            }));
        });

        // Initialize Lucide Icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>