<!DOCTYPE html>
<html lang="ky">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappis — Жазуулар</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    {% csrf_token %}
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen bg-gray-50 flex flex-col" style="font-family: system-ui, -apple-system, sans-serif;">
    <div x-data="ressoBooking()">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 py-4 fixed top-0 left-0 right-0 z-50">
            <div class="flex items-center justify-between px-4 sm:px-6">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-xl">Z</span>
                    </div>
                    <span class="text-xl font-semibold text-gray-900">Zappis</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/notifications/" class="text-gray-600 hover:text-gray-900 relative">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </a>
                    <a href="/settings/" class="text-gray-600 hover:text-gray-900">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </a>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden pt-16">
            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r border-gray-200 p-4 space-y-6 fixed left-0 top-16 bottom-0 overflow-y-auto no-scrollbar">
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-medium text-gray-900" x-text="formatMonthYear(currentDate)"></h3>
                        <div class="flex space-x-2">
                            <button @click="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <button @click="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-xs">
                        <template x-for="day in ['Дш', 'Шш', 'Шр', 'Бш', 'Жм', 'Иш', 'Жк']" :key="day">
                            <div class="text-center text-gray-500 py-1" x-text="day"></div>
                        </template>
                        <template x-for="day in getDaysInMonth(currentDate)" :key="day">
                            <button @click="setDate(day)"
                                    :class="{'bg-blue-600 text-white': day === currentDate.getDate() && isSameMonth(currentDate), 'text-gray-700 hover:text-blue-600': day !== currentDate.getDate() || !isSameMonth(currentDate)}"
                                    class="text-center py-1 rounded hover:bg-blue-50 transition-colors">
                                <span x-text="day"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Навигация -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Навигация</h3>
                    <nav class="space-y-1">
                        <a href="/dashboard/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                            <i data-lucide="home" class="w-5 h-5"></i>
                            <span>Башкы бет</span>
                        </a>
                        <a href="/employees/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            <span>Кызматкерлер</span>
                        </a>
                        <a href="/clients/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                            <i data-lucide="user-plus" class="w-5 h-5"></i>
                            <span>Кардарлар</span>
                        </a>
                        <a href="/schedules/" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-blue-50 text-blue-600">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span>Жазуулар</span>
                        </a>
                        <a href="/services/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                            <i data-lucide="scissors" class="w-5 h-5"></i>
                            <span>Кызматтар</span>
                        </a>
                        <a href="/settings/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                            <span>Жөндөөлөр</span>
                        </a>
                    </nav>
                </div>

                <div>
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Мастерлер</h3>
                    <select x-model="selectedMaster"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">Бардык мастерлер</option>
                        <template x-for="master in masters" :key="master.id">
                            <option :value="master.id" x-text="master.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Кардарды издөө</h3>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input type="text" 
                               placeholder="Аты же телефону боюнча издөө..."
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               x-model="searchQuery"
                               @input="searchClients">
                    </div>
                    <div class="mt-2 max-h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg shadow-sm">
                        <template x-for="result in searchResults" :key="result.id">
                            <div class="p-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                 @click="selectClient(result)">
                                <div class="font-medium text-sm" x-text="result.client?.name || result.client_name || 'Кардар'"></div>
                                <div class="text-xs text-gray-500" x-text="result.client?.phone || result.phone || ''"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </aside>

            <!-- Main Calendar -->
            <main class="flex-1 overflow-auto ml-64 no-scrollbar" style="scroll-behavior: smooth;">
                <div class="min-w-[800px]">
                    <div class="bg-white border-b border-gray-200 sticky top-0 z-20">
                        <div class="flex">
                            <div class="w-16 border-r border-gray-200"></div>
                            <template x-if="view === 'week'">
                                <template x-for="date in getWeekDays()" :key="date.toISOString()">
                                    <div class="flex-1 p-4 text-center border-r border-gray-200 last:border-r-0">
                                        <div class="text-sm text-gray-500" x-text="getDayName(date)"></div>
                                        <div :class="{'text-blue-600': isToday(date), 'text-gray-900': !isToday(date)}"
                                             class="text-xl font-semibold" x-text="date.getDate()"></div>
                                    </div>
                                </template>
                            </template>
                            <template x-if="view === 'day'">
                                <div class="flex-1 p-4 text-center">
                                    <div class="text-sm text-gray-500" x-text="getDayName(currentDate)"></div>
                                    <div :class="{'text-blue-600': isToday(currentDate), 'text-gray-900': !isToday(currentDate)}"
                                         class="text-xl font-semibold" x-text="currentDate.getDate()"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="flex">
                        <div class="w-16 border-r border-gray-200">
                            <div class="h-10"></div>
                            <template x-for="(time, index) in timeSlots" :key="time">
                                <div class="h-10 border-b border-gray-100 flex items-center justify-center text-xs text-gray-500"
                                     x-text="index % 2 === 0 ? time : ''"></div>
                            </template>
                        </div>
                        <template x-if="view === 'week'">
                            <template x-for="date in getWeekDays()" :key="date.toISOString()">
                                <div class="flex-1 border-r border-gray-200 last:border-r-0 relative">
                                    <div class="h-10 bg-gray-50"></div>
                                    <template x-for="slot in timeSlots" :key="slot">
                                        <div class="h-10 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors relative"
                                             @click="if (selectedMaster !== 'all' && !isTimeSlotAvailable(slot, date, selectedMaster)) { showToast('Это время уже занято выбранным мастером', 'error'); return; } showBookingModal = true; selectedBooking = null; setBookingForm(slot, date)"
                                             :class="{'bg-red-50 hover:bg-red-100': !isTimeSlotAvailable(slot, date, selectedMaster) && selectedMaster !== 'all', 'hover:bg-blue-50': isTimeSlotAvailable(slot, date, selectedMaster) || selectedMaster === 'all'}"></div>
                                    </template>
                                    <template x-for="booking in getBookingsForDate(date)" :key="booking.id">
                                        <div class="absolute left-1 right-1 rounded-lg p-2 text-white text-xs cursor-pointer shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-[1.02] z-10"
                                             :style="getBookingStyle(booking)"
                                             @click="selectedBooking = booking; showBookingModal = true; setBookingForm()">
                                            <div class="font-medium truncate" x-text="booking.client?.name || booking.client_name || 'Клиент'"></div>
                                            <div class="text-white/80 truncate">
                                                <span x-text="booking.service?.name || getServiceNameById(booking.service)"></span>
                                            </div>
                                            <div class="text-white/70 text-xs" x-text="formatTimeRange(booking.start_time, booking.end_time)"></div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </template>
                        <template x-if="view === 'day'">
                            <div class="flex-1 relative">
                                <div class="h-10 bg-gray-50"></div>
                                <template x-for="slot in timeSlots" :key="slot">
                                    <div class="h-10 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors relative"
                                         @click="if (selectedMaster !== 'all' && !isTimeSlotAvailable(slot, currentDate, selectedMaster)) { showToast('Это время уже занято выбранным мастером', 'error'); return; } showBookingModal = true; selectedBooking = null; setBookingForm(slot, currentDate)"
                                         :class="{'bg-red-50 hover:bg-red-100': !isTimeSlotAvailable(slot, currentDate, selectedMaster) && selectedMaster !== 'all', 'hover:bg-blue-50': isTimeSlotAvailable(slot, currentDate, selectedMaster) || selectedMaster === 'all'}"></div>
                                </template>
                                <template x-for="booking in getBookingsForDate(currentDate)" :key="booking.id">
                                    <div class="absolute left-1 right-1 rounded-lg p-2 text-white text-xs cursor-pointer shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-[1.02] z-10"
                                         :style="getBookingStyle(booking)"
                                         @click="selectedBooking = booking; showBookingModal = true; setBookingForm()">
                                        <div class="font-medium truncate" x-text="booking.client?.name || booking.client_name || 'Клиент'"></div>
                                        <div class="text-white/80 truncate">
                                            <span x-text="booking.service?.name || getServiceNameById(booking.service)"></span>
                                        </div>
                                        <div class="text-white/70 text-xs" x-text="formatTimeRange(booking.start_time, booking.end_time)"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>

        <!-- Booking Form -->
        <div x-show="showBookingModal" 
             class="fixed inset-0 z-50"
             :class="{'lg:flex lg:items-center lg:justify-center': true}">
            <div class="fixed inset-0 bg-black bg-opacity-50 lg:bg-opacity-0"></div>
            
            <div class="fixed inset-0 lg:relative lg:inset-auto lg:max-w-6xl lg:w-full lg:mx-4 lg:my-8 bg-white lg:rounded-xl lg:shadow-2xl overflow-hidden flex flex-col lg:flex-row">
                <div class="flex-1 p-4 sm:p-6 overflow-y-auto">
                    <div class="flex justify-between items-center mb-4 sm:mb-6 sticky top-0 bg-white pb-4 border-b border-gray-200 lg:border-none lg:pb-0 lg:static">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-900" x-text="selectedBooking ? 'Жазууну түзөтүү' : 'Жаңы жазуу'"></h3>
                        <button @click="showBookingModal = false; selectedBooking = null" 
                                class="text-gray-400 hover:text-gray-600 lg:hidden">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Дата</label>
                                <input type="date" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                       :class="{'border-red-500': errors.date}"
                                       x-model="bookingForm.date">
                                <div x-show="errors.date" class="mt-1 text-sm text-red-600" x-text="errors.date"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Башталышы</label>
                                    <input type="time" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                           :class="{'border-red-500': errors.startTime}"
                                           x-model="bookingForm.startTime">
                                    <div x-show="errors.startTime" class="mt-1 text-sm text-red-600" x-text="errors.startTime"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Аягы</label>
                                    <input type="time" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                           :class="{'border-red-500': errors.endTime}"
                                           x-model="bookingForm.endTime" required>
                                    <div x-show="errors.endTime" class="mt-1 text-sm text-red-600" x-text="errors.endTime"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Кардар</label>
                                <input type="text" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                       :class="{'border-red-500': errors.clientName}"
                                       x-model="bookingForm.clientName" 
                                       placeholder="Кардардын аты">
                                <div x-show="errors.clientName" class="mt-1 text-sm text-red-600" x-text="errors.clientName"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
                                <input type="tel" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                       :class="{'border-red-500': errors.phone}"
                                       x-model="bookingForm.phone" 
                                       @input="formatPhoneNumber"
                                       placeholder="+996 500 123 456">
                                <div x-show="errors.phone" class="mt-1 text-sm text-red-600" x-text="errors.phone"></div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Кызмат</label>
                                <select class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base appearance-none bg-white"
                                        :class="{'border-red-500': errors.service}"
                                        x-model="bookingForm.service">
                                    <option value="">Кызматты тандаңыз</option>
                                    <template x-for="service in services" :key="service.id">
                                        <option :value="service.id" x-text="service.name"></option>
                                    </template>
                                </select>
                                <div x-show="errors.service" class="mt-1 text-sm text-red-600" x-text="errors.service"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Мастер</label>
                                <select class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base appearance-none bg-white"
                                        :class="{'border-red-500': errors.masterId}"
                                        x-model="bookingForm.masterId">
                                    <option value="">Мастерди тандаңыз</option>
                                    <template x-for="master in masters" :key="master.id">
                                        <option :value="master.id" x-text="master.name"></option>
                                    </template>
                                </select>
                                <div x-show="errors.masterId" class="mt-1 text-sm text-red-600" x-text="errors.masterId"></div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Баасы</label>
                                <div class="relative">
                                    <input type="number" 
                                           class="w-full border border-gray-300 rounded-lg pl-8 pr-3 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
                                           :class="{'border-red-500': errors.price}"
                                           x-model="bookingForm.price" 
                                           placeholder="Баасын киргизиңиз"
                                           min="0"
                                           @input="formatPrice">
                                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">⃀</div>
                                </div>
                                <div x-show="errors.price" class="mt-1 text-sm text-red-600" x-text="errors.price"></div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200 sticky bottom-0 bg-white lg:static">
                        <template x-if="selectedBooking">
                            <button @click="deleteBooking(selectedBooking.id)"
                                    class="px-4 py-2.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </template>
                        <button @click="showBookingModal = false; selectedBooking = null"
                                class="px-4 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                            Жокко чыгаруу
                        </button>
                        <button @click="saveBooking"
                                class="px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <span x-text="selectedBooking ? 'Сактоо' : 'Түзүү'"></span>
                        </button>
                    </div>
                </div>

                <div class="hidden lg:block w-80 bg-gray-50 p-6 border-l border-gray-200">
                    <h4 class="text-sm font-medium text-gray-900 mb-4">Жазууну алдын ала көрүү</h4>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Дата жана убакыт</div>
                                <div class="text-sm font-medium text-gray-900" x-text="formatDate(new Date(bookingForm.date)) + ' ' + bookingForm.startTime + ' - ' + bookingForm.endTime"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Кардар</div>
                                <div class="text-sm font-medium text-gray-900" x-text="bookingForm.clientName || 'Көрсөтүлгөн эмес'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <i data-lucide="scissors" class="w-5 h-5 text-purple-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Кызмат</div>
                                <div class="text-sm font-medium text-gray-900" x-text="getServiceNameById(bookingForm.service) || 'Тандалган эмес'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                <i data-lucide="user-check" class="w-5 h-5 text-orange-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Мастер</div>
                                <div class="text-sm font-medium text-gray-900" x-text="masters.find(m => m.id === bookingForm.masterId)?.name || 'Тандалган эмес'"></div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                <i data-lucide="credit-card" class="w-5 h-5 text-red-600"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-500">Баасы</div>
                                <div class="text-sm font-medium text-gray-900" x-text="bookingForm.price ? bookingForm.price + ' ⃀' : 'Көрсөтүлгөн эмес'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Notification Modal -->
        <div x-show="showSmsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Кардарды кабардар кылабызбы?</h3>
                    <button @click="showSmsModal = false" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <p class="text-gray-600">Кардарга WhatsApp аркылуу жазуу тууралуу маалымат жөнөтүү?</p>
                    <div class="flex justify-end space-x-3">
                        <button @click="showSmsModal = false"
                                class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                            Өткөрүп жиберүү
                        </button>
                        <button @click="sendSms(); showSmsModal = false"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            WhatsApp жөнөтүү
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div x-show="toast" class="fixed top-4 right-4 z-50">
            <div :class="{'bg-green-500': toast.type === 'success', 'bg-red-500': toast.type === 'error'}"
                 class="px-4 py-3 rounded-lg shadow-lg text-white">
                <span x-text="toast.message"></span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('ressoBooking', () => ({
                currentDate: new Date(),
                view: 'week',
                selectedMaster: 'all',
                showBookingModal: false,
                showSmsModal: false,
                selectedBooking: null,
                bookingForm: {
                    clientName: '',
                    service: '',
                    masterId: '',
                    startTime: '09:00',
                    endTime: '10:00',
                    phone: '',
                    price: 0,
                    date: '2025-06-15'
                },
                errors: {},
                toast: null,
                searchQuery: '',
                searchResults: [],
                bookings: [],
                services: [],
                masters: [],
                masterColors: [
                    '#2563eb', '#10b981', '#f59e42', '#a21caf', '#ef4444',
                    '#fbbf24', '#0ea5e9', '#6366f1', '#14b8a6', '#e11d48'
                ],
                businessId: null,
                timeSlots: Array.from({ length: 26 }, (_, i) => {
                    const hour = Math.floor(i / 2) + 7;
                    const minute = i % 2 === 0 ? '00' : '30';
                    return `${hour.toString().padStart(2, '0')}:${minute}`;
                }),

                formatDate(date) {
                    return new Intl.DateTimeFormat('ky-KG', { day: 'numeric', month: 'long', year: 'numeric' }).format(date);
                },
                formatMonthYear(date) {
                    return new Intl.DateTimeFormat('ky-KG', { month: 'long', year: 'numeric' }).format(date);
                },
                getDaysInMonth(date) {
                    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                },
                isSameMonth(date) {
                    const today = new Date();
                    return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
                },
                getWeekDays() {
                    const startOfWeek = new Date(this.currentDate);
                    const day = startOfWeek.getDay();
                    const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                    startOfWeek.setDate(diff);
                    const days = [];
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + i);
                        days.push(date);
                    }
                    return days;
                },
                getDayName(date) {
                    return ['Жк', 'Дш', 'Шш', 'Шр', 'Бш', 'Жм', 'Иш'][date.getDay()];
                },
                isToday(date) {
                    const today = new Date();
                    return date.toDateString() === today.toDateString();
                },
                formatTimeRange(startTime, endTime) {
                    if (!startTime || !endTime) return '';
                    const start = startTime.length > 5 ? startTime.slice(0, 5) : startTime;
                    const end = endTime.length > 5 ? endTime.slice(0, 5) : endTime;
                    return `${start}-${end}`;
                },
                getBookingsForDate(date) {
                    if (!Array.isArray(this.bookings)) return [];
                    const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                    return this.bookings.filter(booking => {
                        const matchesDate = booking.date === dateStr;
                        const masterId = booking.master?.id || booking.masterId;
                        const matchesMaster = this.selectedMaster === 'all' || String(masterId) === String(this.selectedMaster);
                        return matchesDate && matchesMaster;
                    });
                },
                isTimeSlotAvailable(timeSlot, date, masterId) {
                    if (!masterId || masterId === '') return true;
                    
                    const dateStr = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
                    const slotStart = this.timeToMinutes(timeSlot);
                    const slotEnd = slotStart + 30; // 30-минутный слот
                    
                    const bookingsOnDate = this.bookings.filter(booking => {
                        const bookingMasterId = booking.master?.id || booking.masterId;
                        return booking.date === dateStr && String(bookingMasterId) === String(masterId);
                    });
                    
                    for (let booking of bookingsOnDate) {
                        const bookingStart = this.timeToMinutes(booking.start_time);
                        const bookingEnd = this.timeToMinutes(booking.end_time);
                        
                        if (slotStart < bookingEnd && slotEnd > bookingStart) {
                            return false;
                        }
                    }
                    
                    return true;
                },
                getBookingStyle(booking) {
                    const startRaw = booking.start_time;
                    const endRaw = booking.end_time;
                    if (!startRaw || !endRaw) return '';

                    // Универсально определяем первый час из timeSlots
                    const minHour = parseInt(this.timeSlots[0].split(':')[0], 10);
                    const start = startRaw.split(':').map(Number);
                    const end = endRaw.split(':').map(Number);
                    const startMinutes = (start[0] - minHour) * 60 + start[1];
                    const endMinutes = (end[0] - minHour) * 60 + end[1];
                    const top = `${(startMinutes / 30) * 2.5}rem`;
                    const height = `${((endMinutes - startMinutes) / 30) * 2.5}rem`;

                    const masterId = booking.master?.id || booking.masterId;
                    const master = this.masters.find(m => String(m.id) === String(masterId));
                    const color = master ? master.color : '#2563eb';

                    const overlappingBookings = this.getOverlappingBookings(booking);
                    const index = overlappingBookings.findIndex(b => b.id === booking.id);
                    const totalOverlapping = overlappingBookings.length;
                    const width = `${100 / totalOverlapping}%`;
                    const left = `${(index * 100) / totalOverlapping}%`;

                    return `top: ${top}; height: ${height}; background-color: ${color}; border: 2px solid ${color}; width: ${width}; left: ${left};`;
                },
                getOverlappingBookings(booking) {
                    return this.bookings.filter(b => {
                        if (b.id === booking.id) return true;
                        if (b.date !== booking.date) return false;
                        
                        const bStart = this.timeToMinutes(b.start_time);
                        const bEnd = this.timeToMinutes(b.end_time);
                        const bookingStart = this.timeToMinutes(booking.start_time);
                        const bookingEnd = this.timeToMinutes(booking.end_time);
                        
                        return (bStart < bookingEnd && bEnd > bookingStart);
                    });
                },
                timeToMinutes(time) {
                    if (!time) return 0;
                    const [hours, minutes] = time.split(':').map(Number);
                    return hours * 60 + minutes;
                },
                changeDate(delta) {
                    const newDate = new Date(this.currentDate);
                    const increment = this.view === 'week' ? 7 : 1;
                    newDate.setDate(newDate.getDate() + delta * increment);
                    this.currentDate = newDate;
                },
                setDate(day) {
                    this.currentDate = new Date(2025, 5, day);
                },
                setBookingForm(clickedTime = null, clickedDate = null) {
                    if (this.selectedBooking) {
                        this.bookingForm = { 
                            clientName: this.selectedBooking.client?.name || this.selectedBooking.client_name || '',
                            phone: this.selectedBooking.client?.phone || this.selectedBooking.phone || '',
                            service: this.selectedBooking.service?.id || this.selectedBooking.service,
                            masterId: this.selectedBooking.master?.id || this.selectedBooking.masterId,
                            startTime: this.selectedBooking.start_time?.slice(0, 5) || this.selectedBooking.start_time,
                            endTime: this.selectedBooking.end_time?.slice(0, 5) || this.selectedBooking.end_time,
                            price: this.selectedBooking.price,
                            date: this.selectedBooking.date
                        };
                    } else {
                        const startTime = clickedTime || '09:00';
                        const [hours, minutes] = startTime.split(':').map(Number);
                        const endTime = `${hours + 1}:${minutes.toString().padStart(2, '0')}`;
                        
                        let dateToUse = clickedDate || this.currentDate;
                        const year = dateToUse.getFullYear();
                        const month = dateToUse.getMonth();
                        const day = dateToUse.getDate();
                        const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        
                        this.bookingForm = {
                            clientName: '',
                            service: '',
                            masterId: '',
                            startTime: startTime,
                            endTime: endTime,
                            phone: '',
                            price: 0,
                            date: formattedDate
                        };
                    }
                },
                validateForm() {
                    this.errors = {};
                    let isValid = true;

                    if (!this.bookingForm.date) {
                        this.errors.date = 'Датаны тандаңыз';
                        isValid = false;
                    }

                    if (!this.bookingForm.startTime) {
                        this.errors.startTime = 'Башталыш убакытты тандаңыз';
                        isValid = false;
                    }

                    if (!this.bookingForm.endTime) {
                        this.errors.endTime = 'Аяктоо убакытты тандаңыз';
                        isValid = false;
                    } else {
                        const start = this.timeToMinutes(this.bookingForm.startTime);
                        const end = this.timeToMinutes(this.bookingForm.endTime);
                        if (end <= start) {
                            this.errors.endTime = 'Аяктоо убакыт башталгандан кийин болушу керек';
                            isValid = false;
                        }
                    }

                    if (!this.bookingForm.clientName) {
                        this.errors.clientName = 'Кардардын атын киргизиңиз';
                        isValid = false;
                    }

                    if (!this.bookingForm.service) {
                        this.errors.service = 'Кызматты тандаңыз';
                        isValid = false;
                    }

                    if (!this.bookingForm.masterId) {
                        this.errors.masterId = 'Мастерди тандаңыз';
                        isValid = false;
                    }

                    if (!this.bookingForm.phone) {
                        this.errors.phone = 'Телефон номерин киргизиңиз';
                        isValid = false;
                    } else {
                        const phoneRegex = /^\+996\s(500|501|502|505|550|551|552|553|554|555|556|557|558|559|700|701|702|703|704|705|706|707|708|709|770|771|772|773|774|775|776|777|778|779|990)\s\d{3}\s\d{3}$/;
                        if (!phoneRegex.test(this.bookingForm.phone)) {
                            this.errors.phone = 'Туура телефон номерин киргизиңиз';
                            isValid = false;
                        }
                    }

                    if (!this.bookingForm.price) {
                        this.errors.price = 'Баасын киргизиңиз';
                        isValid = false;
                    } else if (this.bookingForm.price <= 0) {
                        this.errors.price = 'Баасы 0дөн чоң болушу керек';
                        isValid = false;
                    }

                    return isValid;
                },
                async fetchBookings() {
                    try {
                        const response = await fetch('/schedules/api/bookings/');
                        if (!response.ok) throw new Error('Маалыматтарды жүктөөдө ката кетти');
                        const data = await response.json();
                        this.bookings = Array.isArray(data) ? data : [];
                    } catch (e) {
                        this.bookings = [];
                        this.showToast('Маалыматтарды жүктөөдө ката кетти', 'error');
                    }
                },
                async saveBooking() {
                    if (!this.validateForm()) return;

                    // Проверяем, не занято ли время мастера
                    if (!this.checkTimeAvailability()) {
                        this.showToast('Мастер бул убакта бош эмес, башка убакыт тандаңыз', 'error');
                        return;
                    }

                    const method = this.selectedBooking ? 'PUT' : 'POST';
                    const url = this.selectedBooking
                        ? `/schedules/api/bookings/${this.selectedBooking.id}/`
                        : '/schedules/api/bookings/';
                    const payload = {
                        client_name: this.bookingForm.clientName,
                        client_phone: this.bookingForm.phone,
                        service_id: this.bookingForm.service,
                        master_id: this.bookingForm.masterId,
                        date: this.bookingForm.date,
                        start_time: this.bookingForm.startTime,
                        end_time: this.bookingForm.endTime,
                        price: this.bookingForm.price
                    };

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            const data = await response.json();
                            let errorMessage = 'Сактоодо ката кетти';
                            
                            if (response.status === 400) {
                                // Обрабатываем различные типы ошибок валидации
                                if (data.non_field_errors && data.non_field_errors.length > 0) {
                                    errorMessage = data.non_field_errors[0];
                                } else if (data.detail) {
                                    errorMessage = data.detail;
                                } else if (typeof data === 'string') {
                                    errorMessage = data;
                                } else {
                                    // Обрабатываем ошибки полей
                                    const fieldErrors = [];
                                    for (const [field, errors] of Object.entries(data)) {
                                        if (Array.isArray(errors)) {
                                            fieldErrors.push(`${field}: ${errors[0]}`);
                                        }
                                    }
                                    if (fieldErrors.length > 0) {
                                        errorMessage = fieldErrors.join(', ');
                                    }
                                }
                            }
                            
                            this.showToast(errorMessage, 'error');
                            return;
                        }
                        
                        await this.fetchBookings();
                        const isNewBooking = !this.selectedBooking;
                        this.showToast(this.selectedBooking ? 'Жазуу жаңыртылды' : 'Жазуу түзүлдү', 'success');
                        this.showBookingModal = false;
                        this.selectedBooking = null;
                        this.errors = {};
                        if (isNewBooking) {
                            this.showSmsModal = true;
                        }
                    } catch (e) {
                        console.error('Error saving booking:', e);
                        this.showToast('Жазууну сактоодо ката кетти', 'error');
                    }
                },
                async deleteBooking(id) {
                    try {
                        const response = await fetch(`/schedules/api/bookings/${id}/`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': this.getCsrfToken()
                            }
                        });
                        if (!response.ok) throw new Error('Өчүрүүдө ката кетти');
                        await this.fetchBookings();
                        this.showToast('Жазуу өчүрүлдү', 'success');
                        this.showBookingModal = false;
                        this.selectedBooking = null;
                    } catch (e) {
                        this.showToast('Жазууну өчүрүүдө ката кетти', 'error');
                    }
                },
                getCsrfToken() {
                    const name = 'csrftoken';
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                            return decodeURIComponent(cookie.substring(name.length + 1));
                        }
                    }
                    return '';
                },
                async init() {
                    // Сначала получаем данные пользователя и устанавливаем businessId
                    // Биринчи колдонуучунун маалыматын алып, бизнес ID орнотобуз
                    // Если businessId не установлен, получаем из профиля пользователя
                    // Эгер бизнес ID жок болсо, профилден алабыз
                    // Получаем business_id из данных пользователя
                    // Колдонуучунун маалыматы аркылуу бизнес ID алабыз
                    // Проверяем, не занято ли время мастера
                    // Мастердин убактысы бошпу, текшеребиз
                    // Обрабатываем различные типы ошибок валидации
                    // Ар кандай текшерүү каталарын иштетебиз
                    // Обрабатываем ошибки полей
                    // Талаа каталарын иштетебиз
                    // Универсально определяем первый час из timeSlots
                    // Биринчи саатты timeSlots аркылуу аныктайбыз
                    // Проверяем пересечение интервалов
                    // Интервалдардын кесилишүүсүн текшеребиз
                    // Два интервала пересекаются, если:
                    // Эки интервал кесилишет, эгерде:
                    // 1. Начало одного интервала меньше конца другого И
                    // 1. Бир интервалдын башы экинчисинин аягынан кичине болсо ЖАНА
                    // 2. Конец одного интервала больше начала другого
                    // 2. Бир интервалдын аягы экинчисинин башынан чоң болсо
                    try {
                        const userResponse = await fetch('/accounts/api/profile/');
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            this.businessId = userData.business?.id;
                            
                            if (!this.businessId) {
                                this.showToast('Сизде байланышкан бизнес жок', 'error');
                                return;
                            }
                        } else {
                            this.showToast('Колдонуучу маалыматын алууда ката кетти', 'error');
                            return;
                        }
                    } catch (e) {
                        console.error('Ошибка получения профиля пользователя:', e);
                        this.showToast('Колдонуучу маалыматын алууда ката кетти', 'error');
                        return;
                    }
                    
                    // Затем загружаем остальные данные
                    await Promise.all([this.fetchMasters(), this.fetchServices(), this.fetchBookings()]);
                    this.searchResults = this.bookings;
                },
                changeMonth(delta) {
                    const newDate = new Date(this.currentDate);
                    newDate.setMonth(newDate.getMonth() + delta);
                    this.currentDate = newDate;
                },
                getSmsContent() {
                    const date = new Date(this.bookingForm.date);
                    const formattedDate = new Intl.DateTimeFormat('ky-KG', {
                        day: 'numeric',
                        month: 'long',
                        weekday: 'long'
                    }).format(date);
                    
                    const master = this.masters.find(m => m.id === this.bookingForm.masterId);
                    const masterName = master ? master.name : '';
                    const serviceName = this.getServiceNameById(this.bookingForm.service);

                    return `Салам, ${this.bookingForm.clientName}!\n\n` +
                           `Салонго жазуу тууралуу эскертүү:\n` +
                           `📅 ${formattedDate}\n` +
                           `⏰ ${this.bookingForm.startTime} - ${this.bookingForm.endTime}\n` +
                           `💇‍♀️ ${serviceName}\n` +
                           `👩‍💼 Мастер: ${masterName}\n\n` +
                           `Баасы: ${this.bookingForm.price} сом\n\n` +
                           `Көрүшкөндөргө кубанычтабыз!`;
                },
                async sendSms() {
                    try {
                        const phone = this.bookingForm.phone;
                        const message = this.getSmsContent();
                        
                        if (!phone) {
                            this.showToast('Телефон номери көрсөтүлгөн эмес', 'error');
                            return;
                        }
                        
                        const response = await fetch('/schedules/api/send-whatsapp/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '',
                            },
                            body: JSON.stringify({
                                phone: phone,
                                message: message
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.showToast('WhatsApp билдирүүсү кардарга жөнөтүлдү', 'success');
                        } else {
                            this.showToast(`Жөнөтүүдөгү ката: ${data.error || 'Белгисиз ката'}`, 'error');
                        }
                    } catch (error) {
                        console.error('WhatsApp жөнөтүүдөгү ката:', error);
                        this.showToast('WhatsApp билдирүүсүн жөнөтүүдөгү ката', 'error');
                    }
                },
                formatPhoneNumber(event) {
                    let value = event.target.value.replace(/\D/g, '');
                    if (!value.startsWith('996')) {
                        value = '996' + value;
                    }
                    if (value.length > 12) {
                        value = value.slice(0, 12);
                    }
                    let formattedNumber = '+';
                    if (value.length > 0) {
                        formattedNumber += value.slice(0, 3);
                        if (value.length > 3) {
                            formattedNumber += ' ' + value.slice(3, 6);
                            if (value.length > 6) {
                                formattedNumber += ' ' + value.slice(6, 9);
                                if (value.length > 9) {
                                    formattedNumber += ' ' + value.slice(9, 12);
                                }
                            }
                        }
                    }
                    this.bookingForm.phone = formattedNumber;
                },
                formatPrice(event) {
                    let value = event.target.value.replace(/\D/g, '');
                    if (value === '') {
                        this.bookingForm.price = null;
                        return;
                    }
                    let numValue = parseInt(value);
                    this.bookingForm.price = numValue;
                },
                searchClients() {
                    const query = this.searchQuery.toLowerCase().trim();
                    if (!query) {
                        this.searchResults = this.bookings;
                        return;
                    }
                    this.searchResults = this.bookings.filter(booking => {
                        const clientName = booking.client?.name || booking.client_name || '';
                        const clientPhone = booking.client?.phone || booking.phone || '';
                        const nameMatch = clientName.toLowerCase().includes(query);
                        const phoneMatch = clientPhone.toLowerCase().includes(query);
                        return nameMatch || phoneMatch;
                    });
                },
                selectClient(client) {
                    this.bookingForm.clientName = client.client?.name || client.client_name || '';
                    this.bookingForm.phone = client.client?.phone || client.phone || '';
                    this.searchQuery = '';
                    this.searchResults = [];
                },
                async fetchMasters() {
                    try {
                        const response = await fetch('/employees/api/masters/');
                        if (!response.ok) throw new Error('Мастерлерди жүктөөдө ката кетти');
                        const data = await response.json();
                        this.masters = (Array.isArray(data) ? data : []).map((m, i) => ({
                            ...m,
                            color: this.masterColors[i % this.masterColors.length]
                        }));
                    } catch (e) {
                        this.masters = [];
                        this.showToast('Мастерлерди жүктөөдө ката кетти', 'error');
                    }
                },
                async fetchServices() {
                    try {
                        // Получаем business_id из данных пользователя
                        let businessId = this.businessId;
                        
                        // Если businessId не установлен, получаем из профиля пользователя
                        if (!businessId) {
                            try {
                                const userResponse = await fetch('/accounts/api/profile/');
                                if (userResponse.ok) {
                                    const userData = await userResponse.json();
                                    businessId = userData.business?.id;
                                    this.businessId = businessId; // Сохраняем для последующих запросов
                                    
                                    if (!businessId) {
                                        this.showToast('Сизде байланышкан бизнес жок', 'error');
                                        return;
                                    }
                                } else {
                                    this.showToast('Колдонуучу маалыматын алууда ката кетти', 'error');
                                    return;
                                }
                            } catch (e) {
                                console.error('Ошибка получения профиля пользователя:', e);
                                this.showToast('Колдонуучу маалыматын алууда ката кетти', 'error');
                                return;
                            }
                        }
                        
                        const response = await fetch(`/services/api/services/?business=${businessId}`);
                        if (!response.ok) throw new Error('Кызматтарды жүктөөдө ката кетти');
                        const data = await response.json();
                        this.services = Array.isArray(data) ? data : (Array.isArray(data.results) ? data.results : []);
                        
                        if (this.services.length === 0) {
                            this.showToast('Сизде жеткиликтүү кызматтар жок', 'info');
                        }
                    } catch (e) {
                        console.error('Ошибка загрузки услуг:', e);
                        this.services = [];
                        this.showToast('Кызматтарды жүктөөдө ката кетти', 'error');
                    }
                },
                getServiceNameById(service) {
                    if (typeof service === 'object' && service !== null) {
                        return service.name;
                    }
                    const found = this.services.find(s => String(s.id) === String(service));
                    return found ? found.name : '';
                },
                showToast(message, type = 'success') {
                    this.toast = { message, type };
                    setTimeout(() => this.toast = null, 3000);
                },
                checkTimeAvailability() {
                    // Если это редактирование, исключаем текущую запись из проверки
                    const currentBookingId = this.selectedBooking ? this.selectedBooking.id : null;
                    
                    // Получаем все записи на выбранную дату для выбранного мастера
                    const dateStr = this.bookingForm.date;
                    const bookingsOnDate = this.bookings.filter(booking => {
                        const bookingMasterId = booking.master?.id || booking.masterId;
                        return booking.date === dateStr && 
                               String(bookingMasterId) === String(this.bookingForm.masterId) &&
                               booking.id !== currentBookingId;
                    });
                    
                    console.log('Checking availability for:', {
                        date: dateStr,
                        masterId: this.bookingForm.masterId,
                        startTime: this.bookingForm.startTime,
                        endTime: this.bookingForm.endTime,
                        currentBookingId: currentBookingId
                    });
                    console.log('Bookings on this date for this master:', bookingsOnDate);
                    
                    const newStart = this.timeToMinutes(this.bookingForm.startTime);
                    const newEnd = this.timeToMinutes(this.bookingForm.endTime);
                    
                    for (let booking of bookingsOnDate) {
                        const existingStart = this.timeToMinutes(booking.start_time);
                        const existingEnd = this.timeToMinutes(booking.end_time);
                        
                        console.log('Comparing with:', {
                            bookingId: booking.id,
                            existingTime: `${booking.start_time}-${booking.end_time}`,
                            newTime: `${this.bookingForm.startTime}-${this.bookingForm.endTime}`,
                            existingMinutes: `${existingStart}-${existingEnd}`,
                            newMinutes: `${newStart}-${newEnd}`
                        });
                        
                        // Проверяем пересечение интервалов
                        // Два интервала пересекаются, если:
                        // 1. Начало одного интервала меньше конца другого И
                        // 2. Конец одного интервала больше начала другого
                        if (newStart < existingEnd && newEnd > existingStart) {
                            console.log('CONFLICT FOUND!');
                            return false;
                        }
                    }
                    
                    console.log('No conflicts - time is available');
                    return true;
                }
            }));
        });

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html> 
