<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zappis CRM - Услуги</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        html, body, * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            -webkit-app-region: drag;
        }
        input, textarea {
            user-select: text !important;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="servicesPage()" x-init="init()">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 py-4 fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between px-4 sm:px-6">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">Z</span>
                </div>
                <span class="text-xl font-semibold text-gray-900">Zappis</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/notifications/" class="text-gray-600 hover:text-gray-900 relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                </a>
                <a href="/settings/" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </a>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 p-4 space-y-6 fixed left-0 top-16 bottom-0 overflow-y-auto no-scrollbar z-30">
        <!-- Навигация -->
        <div>
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Навигация</h3>
            <nav class="space-y-1">
                <a href="/dashboard/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span>Главная</span>
                </a>
                <a href="/employees/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Сотрудники</span>
                </a>
                <a href="/clients/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                    <span>Клиенты</span>
                </a>
                <a href="/schedules/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span>Записи</span>
                </a>
                <a href="/services/" class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-blue-50 text-blue-600">
                    <i data-lucide="scissors" class="w-5 h-5"></i>
                    <span>Услуги</span>
                </a>
                <a href="/settings/" class="flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-50">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Настройки</span>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto ml-64 p-6 mt-16">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Услуги</h1>
                <p class="text-gray-500">Управление услугами и категориями</p>
            </div>
            <div class="flex items-center space-x-3">
                <button @click="showAddCategoryModal = true" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center space-x-2">
                    <i data-lucide="folder-plus" class="w-4 h-4"></i>
                    <span>Добавить категорию</span>
                </button>
                <button @click="showAddServiceModal = true" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>Добавить услугу</span>
                </button>
            </div>
        </div>

        <!-- Categories and Services -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Loading State -->
            <div x-show="loading" class="flex items-center justify-center py-12">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="text-gray-600">Загрузка данных...</span>
                </div>
            </div>

            <!-- Content -->
            <template x-for="category in categories" :key="category.id">
                <div class="bg-white rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="folder" class="w-5 h-5 text-blue-600"></i>
                            <h2 class="text-lg font-semibold text-gray-900" x-text="category.name"></h2>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="editCategory(category)" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button @click="deleteCategory(category.id)" class="text-gray-400 hover:text-red-600">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-500 mb-4" x-text="category.description"></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="service in category.services" :key="service.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-colors" :class="{'opacity-50': !service.is_active}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="font-medium text-gray-900" x-text="service.name"></h3>
                                        <p class="text-sm text-gray-500" x-text="service.formatted_duration"></p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button @click="editService(service)" class="text-gray-400 hover:text-gray-600">
                                            <i data-lucide="edit" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="deleteService(service.id)" class="text-gray-400 hover:text-red-600">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-gray-900" x-text="service.formatted_price"></span>
                                    <span :class="service.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 py-1 text-xs rounded-full" x-text="service.is_active ? 'Активна' : 'Неактивна'"></span>
                                </div>
                                <p class="text-gray-500 mt-2" x-text="service.description"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            <!-- Блок для услуг без категории -->
            <template x-if="noCategoryServices && noCategoryServices.length > 0">
                <div class="bg-white rounded-xl p-6">
                    <div class="flex items-center space-x-3 mb-4">
                        <i data-lucide="folder" class="w-5 h-5 text-blue-400"></i>
                        <h2 class="text-lg font-semibold text-gray-900">Без категории</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="service in noCategoryServices" :key="service.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 transition-colors" :class="{'opacity-50': !service.is_active}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="font-medium text-gray-900" x-text="service.name"></h3>
                                        <p class="text-sm text-gray-500" x-text="service.formatted_duration"></p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button @click="editService(service)" class="text-gray-400 hover:text-gray-600">
                                            <i data-lucide="edit" class="w-4 h-4"></i>
                                        </button>
                                        <button @click="deleteService(service.id)" class="text-gray-400 hover:text-red-600">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-gray-900" x-text="service.formatted_price"></span>
                                    <span :class="service.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 py-1 text-xs rounded-full" x-text="service.is_active ? 'Активна' : 'Неактивна'"></span>
                                </div>
                                <p class="text-gray-500 mt-2" x-text="service.description"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>

    </main>

    <!-- Add Service Modal -->
    <div x-show="showAddServiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Добавить услугу</h3>
                <button @click="showAddServiceModal = false; error = null; serviceErrors = {}" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form @submit.prevent="submitService" class="space-y-4">
                <div x-show="error" class="mb-4 bg-red-100 border border-red-300 text-red-700 px-4 py-2 rounded" x-text="error"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Название услуги <span class="text-red-500">*</span></label>
                    <input type="text" x-model="serviceForm.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <div x-show="serviceErrors.name" class="text-xs text-red-600 mt-1" x-text="serviceErrors.name"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                    <select x-model="serviceForm.categoryId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Нет</option>
                        <template x-for="category in categories" :key="category.id">
                            <option :value="category.id" x-text="category.name"></option>
                        </template>
                    </select>
                    <div x-show="serviceErrors.categoryId" class="text-xs text-red-600 mt-1" x-text="serviceErrors.categoryId"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Цена <span class="text-red-500">*</span></label>
                    <input type="number" x-model="serviceForm.price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <div x-show="serviceErrors.price" class="text-xs text-red-600 mt-1" x-text="serviceErrors.price"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Длительность (минуты)</label>
                    <input type="number" x-model="serviceForm.duration" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                    <textarea x-model="serviceForm.description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" x-model="serviceForm.is_active" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label class="ml-2 text-sm text-gray-700">Активная услуга</label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" @click="showAddServiceModal = false; error = null; serviceErrors = {}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Отмена
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div x-show="showAddCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Добавить категорию</h3>
                <button @click="showAddCategoryModal = false" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form @submit.prevent="submitCategory" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Название категории</label>
                    <input type="text" x-model="categoryForm.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                    <textarea x-model="categoryForm.description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" @click="showAddCategoryModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Отмена
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div x-show="showEditServiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Редактировать услугу</h3>
                <button @click="showEditServiceModal = false" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form @submit.prevent="submitEditService" class="space-y-4">
                <div x-show="error" class="mb-4 bg-red-100 border border-red-300 text-red-700 px-4 py-2 rounded" x-text="error"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Название услуги</label>
                    <input type="text" x-model="editServiceForm.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                    <select x-model="editServiceForm.categoryId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Нет</option>
                        <template x-for="category in categories" :key="category.id">
                            <option :value="category.id" x-text="category.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Цена</label>
                    <input type="number" x-model="editServiceForm.price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Длительность (минуты)</label>
                    <input type="number" x-model="editServiceForm.duration" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                    <textarea x-model="editServiceForm.description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" x-model="editServiceForm.is_active" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label class="ml-2 text-sm text-gray-700">Активная услуга</label>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" @click="showEditServiceModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div x-show="showEditCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Редактировать категорию</h3>
                <button @click="showEditCategoryModal = false" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form @submit.prevent="submitEditCategory" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Название категории</label>
                    <input type="text" x-model="editCategoryForm.name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Описание</label>
                    <textarea x-model="editCategoryForm.description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" @click="showEditCategoryModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Отмена</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div x-show="showConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <div class="flex items-center mb-4">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500 mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-900" x-text="confirmModalTitle"></h3>
            </div>
            <p class="text-gray-700 mb-6" x-text="confirmModalText"></p>
            <div class="flex justify-end space-x-3">
                <button @click="showConfirmModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Отмена</button>
                <button @click="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div x-show="showSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center">
            <div class="flex flex-col items-center mb-4">
                <i data-lucide="check-circle" class="w-10 h-10 text-green-500 mb-2"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Успешно!</h3>
                <p class="text-gray-700" x-text="successModalText"></p>
            </div>
            <button @click="showSuccessModal = false" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ок</button>
        </div>
    </div>

    <!-- Initialize Lucide Icons -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Отключить выделение
            document.addEventListener('selectstart', e => e.preventDefault());
            // Отключить копирование/вставку/drag
            document.addEventListener('copy', e => e.preventDefault());
            document.addEventListener('cut', e => e.preventDefault());
            document.addEventListener('paste', e => e.preventDefault());
            document.addEventListener('dragstart', e => e.preventDefault());
            // Отключить F12/DevTools
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey && e.shiftKey && e.key === 'I') || e.key === 'F12') {
                    e.preventDefault();
                }
            });
        });

        // Alpine.js Component
        function servicesPage() {
            return {
                // UI State
                showAddServiceModal: false,
                showAddCategoryModal: false,
                showEditServiceModal: false,
                showEditCategoryModal: false,
                showConfirmModal: false,
                showSuccessModal: false,
                loading: true,
                error: null,
                // Модальные переменные
                confirmModalTitle: '',
                confirmModalText: '',
                successModalText: '',
                // Данные
                businessId: null,
                categories: [],
                noCategoryServices: [],
                serviceErrors: {},
                showInactive: false,
                // Формы
                serviceForm: { name: '', categoryId: '', price: '', duration: '', description: '', is_active: true },
                categoryForm: { name: '', description: '' },
                editServiceForm: { name: '', categoryId: '', price: '', duration: '', description: '', is_active: true },
                editCategoryForm: { name: '', description: '' },

                // Инициализация
                async init() {
                    this.loading = true;
                    this.error = null;
                    try {
                        // Получаем профиль пользователя
                        const userResponse = await fetch('/accounts/api/profile/');
                        if (!userResponse.ok) throw new Error('Ошибка получения профиля');
                        const userData = await userResponse.json();
                        this.businessId = userData.business?.id;
                        if (!this.businessId) throw new Error('У вас нет привязанного бизнеса');
                        await this.loadData();
                    } catch (e) {
                        this.error = e.message || 'Ошибка инициализации';
                        this.categories = [];
                        this.noCategoryServices = [];
                    } finally {
                        this.loading = false;
                    }
                },

                // Загрузка услуг
                async loadData() {
                    this.loading = true;
                    this.error = null;
                    try {
                        // Загружаем категории отдельно
                        const categoriesResponse = await fetch(`/services/api/categories/?business=${this.businessId}`);
                        if (!categoriesResponse.ok) throw new Error('Ошибка загрузки категорий');
                        const categories = await categoriesResponse.json();
                        console.log('DEBUG: Categories loaded:', categories);
                        
                        // Загружаем услуги (все, включая неактивные)
                        let servicesUrl = `/services/api/services/?business=${this.businessId}`;
                        console.log('DEBUG: Loading services from URL:', servicesUrl);
                        const servicesResponse = await fetch(servicesUrl);
                        if (!servicesResponse.ok) throw new Error('Ошибка загрузки услуг');
                        const services = await servicesResponse.json();
                        console.log('DEBUG: Services received:', services);
                        
                        // Группируем услуги по категориям
                        const categoriesMap = {};
                        const noCategory = [];
                        
                        // Сначала создаём все категории (даже пустые)
                        for (const category of categories) {
                            categoriesMap[category.id] = {
                                id: category.id,
                                name: category.name,
                                description: category.description || '',
                                services: []
                            };
                        }
                        
                        // Затем добавляем услуги в соответствующие категории
                        for (const service of services) {
                            if (service.category && service.category.id) {
                                if (categoriesMap[service.category.id]) {
                                    categoriesMap[service.category.id].services.push(service);
                                }
                            } else {
                                noCategory.push(service);
                            }
                        }
                        
                        this.categories = Object.values(categoriesMap);
                        this.noCategoryServices = noCategory;
                        console.log('DEBUG: Categories processed:', this.categories);
                        console.log('DEBUG: No category services:', this.noCategoryServices);
                        setTimeout(() => lucide.createIcons(), 0);
                    } catch (e) {
                        this.error = e.message || 'Ошибка загрузки данных';
                        this.categories = [];
                        this.noCategoryServices = [];
                    } finally {
                        this.loading = false;
                    }
                },
                // Остальные методы (submitService, editService, deleteService, submitCategory, editCategory, deleteCategory, confirmDelete, resetServiceForm, resetCategoryForm, getCategoryIdByService, getCsrfToken) оставляем без изменений
                editService(service) {
                    this.editServiceForm = {
                        name: service.name,
                        categoryId: service.category?.id || '',
                        price: service.price,
                        duration: service.duration,
                        description: service.description || '',
                        is_active: service.is_active !== false
                    };
                    this.confirmServiceId = service.id;
                    this.showEditServiceModal = true;
                },
                editCategory(category) {
                    this.editCategoryForm = {
                        name: category.name,
                        description: category.description || ''
                    };
                    this.confirmCategoryId = category.id;
                    this.showEditCategoryModal = true;
                },
                deleteService(serviceId) {
                    this.confirmServiceId = serviceId;
                    this.confirmCategoryId = null;
                    this.confirmModalTitle = 'Удаление услуги';
                    this.confirmModalText = 'Вы уверены, что хотите удалить эту услугу? Все данные будут удалены безвозвратно.';
                    this.showConfirmModal = true;
                },
                deleteCategory(categoryId) {
                    this.confirmCategoryId = categoryId;
                    this.confirmServiceId = null;
                    this.confirmModalTitle = 'Удаление категории';
                    this.confirmModalText = 'Вы уверены, что хотите удалить эту категорию? Все услуги в ней также будут удалены.';
                    this.showConfirmModal = true;
                },
                async confirmDelete() {
                    try {
                        if (this.confirmServiceId) {
                            console.log('DEBUG: Deleting service with ID:', this.confirmServiceId);
                            const response = await fetch(`/services/api/services/${this.confirmServiceId}/?business=${this.businessId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': this.getCsrfToken()
                                }
                            });
                            console.log('DEBUG: Service deletion response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Ошибка удаления услуги');
                            }
                            this.successModalText = 'Услуга успешно удалена!';
                        } else if (this.confirmCategoryId) {
                            console.log('DEBUG: Deleting category with ID:', this.confirmCategoryId);
                            const response = await fetch(`/services/api/categories/${this.confirmCategoryId}/?business=${this.businessId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': this.getCsrfToken()
                                }
                            });
                            console.log('DEBUG: Category deletion response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Ошибка удаления категории');
                            }
                            this.successModalText = 'Категория успешно удалена!';
                        }

                        await this.loadData();
                        this.showConfirmModal = false;
                        this.showSuccessModal = true;
                    } catch (error) {
                        console.error('Error deleting:', error);
                        this.error = 'Ошибка удаления';
                        this.showConfirmModal = false;
                    }
                },
                async submitEditService() {
                    this.serviceErrors = {};
                    this.error = null;
                    if (!this.editServiceForm.name) {
                        this.serviceErrors.name = 'Пожалуйста, заполните это поле';
                    }
                    if (!this.editServiceForm.price) {
                        this.serviceErrors.price = 'Пожалуйста, укажите цену';
                    }
                    if (Object.keys(this.serviceErrors).length > 0) {
                        return;
                    }
                    try {
                        const payload = {
                            name: this.editServiceForm.name,
                            category_id: this.editServiceForm.categoryId === '' ? null : parseInt(this.editServiceForm.categoryId),
                            price: parseInt(this.editServiceForm.price),
                            duration: parseInt(this.editServiceForm.duration) || null,
                            description: this.editServiceForm.description,
                            is_active: this.editServiceForm.is_active,
                            business_id: this.businessId
                        };
                        const response = await fetch(`/services/api/services/${this.confirmServiceId}/`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                        const respData = await response.clone().json().catch(() => null);
                        if (!response.ok) {
                            if (respData && typeof respData === 'object') {
                                for (const key in respData) {
                                    if (key === 'business_id') this.serviceErrors.businessId = respData[key][0];
                                    if (this.serviceErrors[key] !== undefined) {
                                        this.serviceErrors[key] = respData[key][0];
                                    }
                                }
                            }
                            throw new Error('Ошибка обновления услуги');
                        }
                        await this.loadData();
                        this.showEditServiceModal = false;
                        this.successModalText = 'Услуга успешно обновлена!';
                        this.showSuccessModal = true;
                        this.error = null;
                    } catch (error) {
                        console.error('Error updating service:', error);
                        if (!Object.values(this.serviceErrors).some(Boolean)) {
                            this.error = 'Ошибка обновления услуги';
                        }
                    }
                },
                async submitService() {
                    this.serviceErrors = {};
                    this.error = null;
                    if (!this.serviceForm.name) {
                        this.serviceErrors.name = 'Пожалуйста, заполните это поле';
                    }
                    if (!this.serviceForm.price) {
                        this.serviceErrors.price = 'Пожалуйста, укажите цену';
                    }
                    if (Object.keys(this.serviceErrors).length > 0) {
                        return;
                    }
                    try {
                        const payload = {
                            name: this.serviceForm.name,
                            category_id: this.serviceForm.categoryId === '' ? null : parseInt(this.serviceForm.categoryId),
                            price: parseInt(this.serviceForm.price),
                            duration: parseInt(this.serviceForm.duration) || null,
                            description: this.serviceForm.description,
                            is_active: this.serviceForm.is_active,
                            business_id: this.businessId
                        };
                        const response = await fetch('/services/api/services/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                        const respData = await response.clone().json().catch(() => null);
                        if (!response.ok) {
                            if (respData && typeof respData === 'object') {
                                for (const key in respData) {
                                    if (key === 'business_id') this.serviceErrors.businessId = respData[key][0];
                                    if (this.serviceErrors[key] !== undefined) {
                                        this.serviceErrors[key] = respData[key][0];
                                    }
                                }
                            }
                            throw new Error('Ошибка создания услуги');
                        }
                        await this.loadData();
                        this.showAddServiceModal = false;
                        this.resetServiceForm();
                        this.successModalText = 'Услуга успешно добавлена!';
                        this.showSuccessModal = true;
                        this.error = null;
                    } catch (error) {
                        console.error('Error creating service:', error);
                        if (!Object.values(this.serviceErrors).some(Boolean)) {
                            this.error = 'Ошибка создания услуги';
                        }
                    }
                },
                async submitCategory() {
                    if (!this.categoryForm.name) {
                        return;
                    }
                    try {
                        const payload = {
                            name: this.categoryForm.name,
                            description: this.categoryForm.description,
                            business_id: this.businessId
                        };
                        console.log('DEBUG: Creating category with payload:', payload);
                        const response = await fetch('/services/api/categories/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                        console.log('DEBUG: Category creation response status:', response.status);
                        if (!response.ok) {
                            const errorData = await response.json();
                            console.log('DEBUG: Category creation error:', errorData);
                            throw new Error('Ошибка создания категории');
                        }
                        const createdCategory = await response.json();
                        console.log('DEBUG: Category created successfully:', createdCategory);
                        await this.loadData();
                        this.showAddCategoryModal = false;
                        this.resetCategoryForm();
                        this.successModalText = 'Категория успешно добавлена!';
                        this.showSuccessModal = true;
                    } catch (error) {
                        console.error('Error creating category:', error);
                        this.error = 'Ошибка создания категории';
                    }
                },
                resetServiceForm() {
                    this.serviceForm = {
                        name: '',
                        categoryId: '',
                        price: '',
                        duration: '',
                        description: '',
                        is_active: true
                    };
                },
                resetCategoryForm() {
                    this.categoryForm = {
                        name: '',
                        description: ''
                    };
                },
                getCsrfToken() {
                    const name = 'csrftoken';
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                            return decodeURIComponent(cookie.substring(name.length + 1));
                        }
                    }
                    return '';
                },
            }
        }
    </script>
</body>
</html> 